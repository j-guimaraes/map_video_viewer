<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Georreferenced Video Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; }
        
        /* Ecr√£ de upload */
        #upload-screen { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            height: auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            overflow-y: auto; 
        }
        .upload-container { 
            background: white; 
            border-radius: 15px; 
            padding: 40px; 
            max-width: 600px; 
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin: auto;
            max-height: auto; 
        }
        .upload-container h1 { 
            color: #333; 
            margin-bottom: 10px;
            font-size: 28px;
        }
        .upload-container p { 
            color: #666; 
            margin-bottom: 30px;
        }
        .upload-area { 
            border: 3px dashed #ddd; 
            border-radius: 10px; 
            padding: 30px; 
            text-align: center;
            margin-bottom: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-area:hover { 
            border-color: #667eea; 
            background: #f8f9ff;
        }
        .upload-area.loaded { 
            border-color: #10b981; 
            background: #f0fdf4;
        }
        .upload-area input { display: none; }
        .upload-area label { 
            cursor: pointer; 
            display: block;
        }
        .upload-icon { 
            font-size: 40px; 
            margin-bottom: 10px;
        }
        .upload-text { 
            color: #666; 
            font-size: 14px;
        }
        .upload-status { 
            color: #10b981; 
            font-weight: bold; 
            margin-top: 10px;
            font-size: 14px;
        }
        .btn-start { 
            width: 100%; 
            background: #667eea; 
            color: white; 
            border: none; 
            padding: 15px; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .btn-start:hover { 
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-start:disabled { 
            background: #ccc; 
            cursor: not-allowed;
            transform: none;
        }
        .error-msg { 
            background: #fee; 
            color: #c00; 
            padding: 10px; 
            border-radius: 5px; 
            margin-top: 10px;
            font-size: 14px;
        }
        
        /* Visualizador */
        #viewer-screen { display: none; }
        #container { display: flex; height: 100vh; }
        #header {
            position: absolute;
            top: 0;
            left: 0;
            right: 520px;
            z-index: 1000;
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 12px 20px; 
            background-color: #ffffff; 
            border-bottom: 1px solid #ddd; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #header h1 {font-weight: bold; font-size: 28px; margin: 0;  line-height: 40px;}
        #logo {height: 40px;}
        #map-container { flex: 1;padding-top: 65px;  /* Altura do header */}
        #map { width: 100%; height: 100%; }
        
        #video-container { 
            width: 520px; 
            background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
            border-radius: 8px;
            display: flex; 
            flex-direction: column;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        #player { width: 100%; height: 340px; }
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        
        /* Responsivo */
        @media (max-width: 768px) {
            #video-container { width: 100%; }
            #player { height: 250px; }
            #header { right: 0; }  /* Header ocupa tudo em mobile */
        }
        
        #controls { 
            background: linear-gradient(180deg, #1e1e1e 0%, #151515 100%); 
            color: white; 
            padding: 20px; 
            flex: 1; 
            overflow-y: auto;
        }
        
        .control-group { 
            margin-bottom: 20px;
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .control-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-size: 13px; 
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        button.control-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            padding: 10px 16px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 0 5px 8px 0;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.3);
        }
        button.control-btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.5);
        }

        button.control-btn:active {
            transform: translateY(0);
        }
        
        #sync-indicator { 
            padding: 10px 16px; 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 8px; 
            font-size: 12px;
            display: inline-block;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(16, 185, 129, 0.3);
        }
        
        #sync-indicator.inactive { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 3px 8px rgba(239, 68, 68, 0.3);
        }
        
        .info-box { 
            background: rgba(255,255,255,0.08);
            padding: 15px; 
            border-radius: 10px; 
            margin-top: 10px;
            font-size: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .info-box div { 
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .info-box div:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* Cr√©ditos no canto inferior esquerdo */
        #credits {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        #credits a {
            color: white;
            text-decoration: underline;
        }
        
        #credits a:hover {
            color: #667eea;
        }
        
        /* Popup moderno */
        .leaflet-popup-content-wrapper { 
            border-radius: 12px; 
            padding: 0;
            min-width: 260px;  
            max-width: 380px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .leaflet-popup-tip {
            box-shadow: 0 3px 14px rgba(0,0,0,0.1);
        }
        
        .popup-content { 
            padding: 0;
        }
        
        .popup-content h3 { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            padding: 10px 16px; 
            border-radius: 8px; 
            margin: 0 5px 8px 0;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.3);
        }
        
        .popup-content p { 
            margin: 0;
            padding: 12px 20px;
            font-size: 13px;
            border-bottom: 1px solid #f0f0f0;
            background: white;
        }
        
        .popup-content p:last-of-type {
            border-bottom: none;
        }
        
        .popup-content p strong1 {
            color: #667eea;
            font-weight: 600;
        }
        
        .popup-content p strong {
            color: #667eea;
            font-weight: 600;
        }
        
        .popup-content img { 
            width: 100%; 
            border-radius: 5px; 
            margin: 10px 0;
            max-height: 200px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .popup-content img:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);

        }
        .popup-content p { margin: 5px 0; font-size: 13px; }
        
        .popup-content a {
            display: inline-block;
            margin: 12px 20px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.3);
        }
        
        .popup-content a:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.5);
        }
        
        /* Modal para Photo em tamanho real */
        #Photo-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            cursor: pointer;
        }
        #Photo-modal img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            border-radius: 8px;
        }
        #Photo-modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10001;
        }
        #Photo-modal-close:hover {
            color: #bbb;
        }
        
        @media (max-width: 768px) {
            #container { flex-direction: column; }
            #video-container { width: 100%; height: 50%; }
            #map-container { height: 50%; }
        }

        /* Anima√ß√£o hover nos marcadores */
        .custom-marker-icon:hover div {
            transform: scale(1.15) !important;
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6), 0 0 0 6px rgba(239, 68, 68, 0.15) !important;
        }

        /* Pontos GPS modernos - SEM transform */
        .gps-point {
            cursor: pointer;
        }
        
    </style>
</head>
<body>
    <!-- Ecr√£ de Upload -->
    <div id="upload-screen">
        <div class="upload-container">
            <h1>üó∫Ô∏è Georeferenced Route and Video Viewer</h1>
            <p>Upload the 3 GeoJSON files and photo folder to get started</p>
            
            <div class="upload-area" id="area-pontos">
                <label for="file-points">
                    <div class="upload-icon">üìç</div>
                    <div class="upload-text">Critical Points (.json)</div>
                    <div class="upload-status" id="status-points"></div>
                </label>
                <input type="file" id="file-points" accept=".json,.geojson">
            </div>
            
            <div class="upload-area" id="area-track">
                <label for="file-track">
                    <div class="upload-icon">üõ∞Ô∏è</div>
                    <div class="upload-text">GPS Track (.json)</div>
                    <div class="upload-status" id="status-track"></div>
                </label>
                <input type="file" id="file-track" accept=".json,.geojson">
            </div>
            
            <div class="upload-area" id="area-route">
                <label for="file-route">
                    <div class="upload-icon">üõ£Ô∏è</div>
                    <div class="upload-text">Route (.json)</div>
                    <div class="upload-status" id="status-route"></div>
                </label>
                <input type="file" id="file-route" accept=".json,.geojson">
            </div>
            
            <div class="upload-area" id="area-Photos">
                <label for="file-Photos">
                    <div class="upload-icon">üì∏</div>
                    <div class="upload-text">Photo's folder (multiple .jpg)</div>
                    <div class="upload-status" id="status-Photos"></div>
                </label>
                <input type="file" id="file-Photos" accept="image/*" multiple webkitdirectory directory>
            </div>
            
            <div id="error-container"></div>
            
            <button class="btn-start" id="btn-start" disabled>Upload to Viewer</button>
        </div>
    </div>

    <!-- Ecr√£ do Visualizador -->
    <div id="viewer-screen">
        <!-- Modal para Photo em tamanho real -->
        <div id="Photo-modal" onclick="fecharModal()">
            <span id="Photo-modal-close">&times;</span>
            <img id="Photo-modal-img">
        </div>
        
        <div id="container">
            <header id="header">
              <img id="logo" src="logoMGCS.jpg" alt="Logo">
              <h1> üó∫Ô∏è Georeferenced Route and Video Viewer</h1>
            </header>

            <div id="map-container">
                <div id="map"></div>
            </div>
            <div id="video-container">
                <div id="player"></div>
                <div id="controls">
                    <div class="control-group">
                        <label>Sync Status</label>
                        <span id="sync-indicator">Uploading...</span>
                    </div>
                    
                    <div class="control-group">
                        <label>Controls</label>
                        <button class="control-btn" onclick="togglePlayPause()">‚ñ∂Ô∏è Play/Pause</button>
                        <button class="control-btn" onclick="resetView()">üîÑ Reset View</button>
                    </div>
                    
                    <div class="info-box">
                        <div><strong>Critical/Relevant Points:</strong> <span id="info-critical">-</span></div>
                        <div><strong>GPS Track:</strong> <span id="info-track">-</span></div>
                        <div><strong>Distance:</strong> <span id="info-distance">-</span></div>
                        <div><strong>Time:</strong> <span id="current-time">00:00</span> / <span id="total-time">00:00</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Dados carregados
        let DATA = {
            points: null,
            track: null,
            route: null,
            videoId: null,
            Photos: {}  // Objeto para armazenar Photos como URLs
        };
        
        // Vari√°veis do visualizador
        let player, map;
        let layers = { track: null, critical: null, road: null };
        let markers = { track: [], critical: [] };
        let syncInterval = null;
        
        // Upload de ficheiros
        function setupFileUpload(type, inputId, areaId, statusId) {
            const input = document.getElementById(inputId);
            const area = document.getElementById(areaId);
            const status = document.getElementById(statusId);
            
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        // Processar dados
                        if (type === 'points') {
                            // Adicionar .jpg aos nomes das Photos
                            data.features = data.features.map(f => ({
                                ...f,
                                properties: {
                                    ...f.properties,
                                    Photo: f.properties.Photo ? `${f.properties.Photo}.jpg` : null
                                }
                            }));
                        }
                        
                        DATA[type] = data;
                        status.textContent = '‚úì Loaded';
                        area.classList.add('loaded');
                        
                        // Extrair Video ID se for track
                        if (type === 'track' && !DATA.videoId) {
                            for (const f of data.features) {
                                if (f.properties.link_video) {
                                    const match = f.properties.link_video.match(/(?:v=|youtu\.be\/)([^&?]+)/);
                                    if (match) {
                                        DATA.videoId = match[1];
                                        break;
                                    }
                                }
                            }
                        }
                        
                        checkAllLoaded();
                    } catch (err) {
                        showError(`Error reading ${type}: ${err.message}`);
                        status.textContent = '‚úó Error';
                    }
                };
                reader.readAsText(file);
            });
        }
        
        function checkAllLoaded() {
            const btn = document.getElementById('btn-start');
            if (DATA.points && DATA.track && DATA.route && Object.keys(DATA.Photos).length > 0) {
                btn.disabled = false;
            }
        }
        
        function showError(msg) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error-msg">${msg}</div>`;
        }
        
        // Inicializar uploads
        setupFileUpload('points', 'file-points', 'area-points', 'status-points');
        setupFileUpload('track', 'file-track', 'area-track', 'status-track');
        setupFileUpload('route', 'file-route', 'area-route', 'status-route');
        setupPhotosUpload();
        
        // Upload de Photos
        function setupPhotosUpload() {
            const input = document.getElementById('file-Photos');
            const area = document.getElementById('area-Photos');
            const status = document.getElementById('status-Photos');
            
            input.addEventListener('change', (e) => {
                const files = e.target.files;
                if (!files || files.length === 0) return;
                
                let count = 0;
                DATA.Photos = {}; // Limpar Photos anteriores
                
                // Processar cada ficheiro
                Array.from(files).forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const url = URL.createObjectURL(file);
                        // Guardar com o nome do ficheiro
                        DATA.Photos[file.name] = url;
                        count++;
                    }
                });
                
                if (count > 0) {
                    status.textContent = `‚úì ${count} Photo${count > 1 ? 's' : ''} Uploaded${count > 1 ? 's' : ''}`;
                    area.classList.add('loaded');
                    checkAllLoaded();
                } else {
                    status.textContent = '‚úó No images found';
                }
            });
        }
        
        // Bot√£o iniciar
        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('upload-screen').style.display = 'none';
            document.getElementById('viewer-screen').style.display = 'block';
            initYouTube();
        });
        
        // YouTube API
        function initYouTube() {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            document.head.appendChild(tag);
        }
        
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '270',
                width: '480',
                videoId: DATA.videoId,
                playerVars: { playsinline: 1, controls: 1, rel: 0 },
                events: {
                    onReady: onPlayerReady,
                    onStateChange: onPlayerStateChange,
                    onError: onPlayerError
                }
            });
        }
        
        function onPlayerReady() {
            initMap();
            updateStats();
            startSync();
        }
        
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                startSync();
            }
        }
        
        function onPlayerError(event) {
            const errors = {
                2: 'Invalid Request',
                5: 'Error on HTML5 player',
                100: 'Video not found',
                101: 'Video does not allow embedding',
                150: 'Restricted video for embedding',
                153: 'Referrer error - local file not supported'
            };
            
            if (event.data === 153) {
                // Erro 153: ficheiro local n√£o funciona
                document.getElementById('sync-indicator').textContent = 'Map Only Mode (Error 153)';
                document.getElementById('sync-indicator').classList.add('inactive');
                
                // Criar link para YouTube
                const videoLink = `https://www.youtube.com/watch?v=${DATA.videoId}`;
                const playerDiv = document.getElementById('player');
                playerDiv.innerHTML = `
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;background:#1a1a1a;color:white;text-align:center;padding:20px;">
                        <div style="font-size:48px;margin-bottom:20px;">‚ö†Ô∏è</div>
                        <div style="font-size:16px;margin-bottom:10px;font-weight:bold;">Error 153: YouTube blocked</div>
                        <div style="font-size:13px;color:#aaa;margin-bottom:20px;">Local files (file://) can't upload YouTube videos</div>
                        <a href="${videoLink}" target="_blank" style="background:#ff0000;color:white;padding:12px 24px;border-radius:5px;text-decoration:none;font-weight:bold;">‚ñ∂Ô∏è Open in YouTube</a>
                        <div style="font-size:12px;color:#666;margin-top:20px;">üí° Solution: Use a local server or host online</div>
                    </div>
                `;
                
                // Continuar com mapa funcional
                alert('‚ö†Ô∏è Error 153: YouTube stuck on local files\n\n‚úÖ The map remains functional!\n\nüí° Solutions:\n1. Open video in other tab (link generated)\n2. Use a local server (python -m http.server)\n3. Online host (GitHub Pages, Netlify)');
            } else {
                alert('‚ö†Ô∏è Erro YouTube (' + event.data + '): ' + (errors[event.data] || 'Unknown error'));
                document.getElementById('sync-indicator').textContent = 'Video Error';
                document.getElementById('sync-indicator').classList.add('inactive');
            }
        }
        
        function updateStats() {
            document.getElementById('info-critical').textContent = DATA.points.features.length;
            document.getElementById('info-track').textContent = DATA.track.features.length;
            const dist = DATA.route.features[0]?.properties?.Comprimento || 0;
            document.getElementById('info-distance').textContent = (dist / 1000).toFixed(2) + ' km';
        }
        
        function initMap() {
            const first = DATA.track.features[0].geometry.coordinates;
            map = L.map('map').setView([first[1], first[0]], 14);
            
            // Camadas base
            const osmBase = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            });
            
            const googleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                attribution: '¬© Google',
                maxZoom: 20
            });
            
            const ortoPhotosPT = L.tileLayer.wms('https://ortos.dgterritorio.gov.pt/wms/ortosat2023', {
                layers: 'ortoSat2023-CorVerdadeira',
                format: 'image/png',
                transparent: true,
                attribution: '¬© DGTerrit√≥rio'
            });
            
            // Adicionar OSM por defeito
            osmBase.addTo(map);
            
            // Estrada base
            layers.road = L.geoJSON(DATA.route, {
                style: { color: '#666', weight: 4, opacity: 0.6 }
            }).addTo(map);
            
            // Pontos GPS
            // Pontos GPS com estilo moderno
            DATA.track.features.forEach((f) => {
                const c = f.geometry.coordinates;
                const m = L.circleMarker([c[1], c[0]], {
                    radius: 3,
                    fillColor: '#3b82f6',
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                // Hover effect via JavaScript (mais est√°vel)
                m.on('mouseover', function() {
                    this.setStyle({
                        radius: 5,
                        weight: 3
                    });
                });
                
                m.on('mouseout', function() {
                    // Verifica se n√£o √© um ponto j√° percorrido (verde)
                    if (this.options.fillColor !== '#10b981') {
                        this.setStyle({
                            radius: 4,
                            weight: 2
                        });
                    }
                });
                
                m.on('click', () => {
                    if (player && player.seekTo) {
                        player.seekTo(f.properties.video_sec, true);
                    }
                });
                
                markers.track.push(m);
            });
            
            layers.track = L.layerGroup(markers.track).addTo(map);
            
            // Pontos cr√≠ticos
            // Pontos cr√≠ticos com estilo moderno
            DATA.points.features.forEach(f => {
                const c = f.geometry.coordinates;
                const p = f.properties;
                
                const icon = L.divIcon({
                    html: `
                        <div style="
                            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                            border: 2px solid white;
                            border-radius: 50%;
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                            font-size: 15px;
                            color: white;
                            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4), 0 0 0 4px rgba(239, 68, 68, 0.1);
                            cursor: pointer;
                            transition: all 0.3s ease;
                        ">${p.id}</div>
                    `,
                    className: 'custom-marker-icon',
                    iconSize: [36, 36],
                    iconAnchor: [18, 18]
                });
                
                const m = L.marker([c[1], c[0]], { icon });
                
                let popup = `<div class="popup-content">
                    <h3>üìç Point ${p.id}</h3>`;
                popup += `<p><strong1>${p.Description || 'No description'}</strong1></p>`;
                if (p.['Approximate width (m)']) popup += `<p><strong>‚ÜîÔ∏è Width:</strong> ${p.['Approximate width (m)']}m</p>`;
                if (p.['Approximate height (m)']) popup += `<p><strong>‚¨ÜÔ∏è Height:</strong> ${p.['Approximate height (m)']}m</p>`;
                if (p.Remarks) popup += `<p><strong>üí¨ Notes:</strong><br><br>${p.Remarks.replace(/\n/g, '<br>')}</p>`;
                
                // Procurar Photo correspondente
                if (p.Photo) {
                    const PhotoNome = p.Photo.split('/').pop();
                    let PhotoUrl = null;
                    
                    for (const [nome, url] of Object.entries(DATA.Photos)) {
                        if (nome === PhotoNome || nome.includes(PhotoNome.replace('.jpg', ''))) {
                            PhotoUrl = url;
                            break;
                        }
                    }
                    
                    if (PhotoUrl) {
                        popup += `<img src="${PhotoUrl}" alt="Photo" onclick="abrirPhoto('${PhotoUrl}'); event.stopPropagation();" title="Click to open">`;
                    } else {
                        popup += `<p style="color:#999;font-size:11px;padding:8px 20px;">üì∑ Photo not found: ${PhotoNome}</p>`;
                    }
                }
                
                if (p.Video) popup += `<a href="${p.Video}" target="_blank">üé• Open video in another tab</a>`;
                popup += '</div>';
                
                m.bindPopup(popup, { 
                    maxWidth: 380,
                    className: 'modern-popup'
                });
                markers.critical.push(m);
            });
            
            layers.critical = L.layerGroup(markers.critical).addTo(map);
            
            // Controlo de camadas (AGORA SIM, depois de criar tudo!)
            const baseMaps = {
                "üó∫Ô∏è OpenStreetMap": osmBase,
                "üõ∞Ô∏è Google Hybrid": googleHybrid,
                "üì∑ Orthophotos PT 2023": ortoPhotosPT
            };
            
            const overlayMaps = {
                "üîµ GPS Track": layers.track,
                "üî¥ Critical/Relevant Points": layers.critical,
                "‚ö´ Route": layers.road
            };
            
            L.control.layers(baseMaps, overlayMaps, {
                position: 'topright',
                collapsed: false
            }).addTo(map);
            
            // Ajustar vista
            const all = [...DATA.track.features, ...DATA.points.features];
            const bounds = L.latLngBounds(all.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0]]));
            map.fitBounds(bounds, { padding: [50, 50] });
        }
        
        function startSync() {
            if (syncInterval) clearInterval(syncInterval);
            
            syncInterval = setInterval(() => {
                if (!player || !player.getCurrentTime) return;
                
                const t = player.getCurrentTime();
                const d = player.getDuration();
                
                document.getElementById('current-time').textContent = formatTime(t);
                document.getElementById('total-time').textContent = formatTime(d);
                
                markers.track.forEach((m, i) => {
                    const pt = DATA.track.features[i].properties.video_sec;
                    
                    if (pt <= t) {
                        m.setStyle({ fillColor: '#10b981', color: '#047857', radius: 4, fillOpacity: 0.8 });
                    } else if (pt <= t + 5) {
                        m.setStyle({ fillColor: '#f59e0b', color: '#d97706', radius: 5, fillOpacity: 1 });
                    } else {
                        m.setStyle({ fillColor: '#3b82f6', color: '#1e40af', radius: 3, fillOpacity: 0.6 });
                    }
                });
                
                document.getElementById('sync-indicator').textContent = 'Synchronized';
                document.getElementById('sync-indicator').classList.remove('inactive');
            }, 500);
        }
        
        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return m.toString().padStart(2, '0') + ':' + sec.toString().padStart(2, '0');
        }
        
        function togglePlayPause() {
            if (!player) return;
            player.getPlayerState() === 1 ? player.pauseVideo() : player.playVideo();
        }
        
        function toggleLayer(l) {
            if (!map || !layers[l]) return;
            
            if (map.hasLayer(layers[l])) {
                map.removeLayer(layers[l]);
                document.getElementById('btn-' + l).style.opacity = '0.5';
            } else {
                map.addLayer(layers[l]);
                document.getElementById('btn-' + l).style.opacity = '1';
            }
        }
        
        function resetView() {
            const all = [...DATA.track.features, ...DATA.points.features];
            const bounds = L.latLngBounds(all.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0]]));
            map.fitBounds(bounds, { padding: [50, 50] });
        }
        
        // Fun√ß√µes para modal de Photo
        function abrirPhoto(url) {
            document.getElementById('Photo-modal-img').src = url;
            document.getElementById('Photo-modal').style.display = 'block';
        }
        
        function fecharModal() {
            document.getElementById('Photo-modal').style.display = 'none';
        }
        
        // Fechar modal com tecla ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                fecharModal();
            }
        });
    </script>
    
    <!-- Cr√©ditos -->
    <div id="credits">
        Developed by <a href="https://www.linkedin.com/in/jose-mesquita-guimaraes" target="_blank">Jos√© Mesquita Guimar√£es</a>
    </div>
    
</body>
</html>
